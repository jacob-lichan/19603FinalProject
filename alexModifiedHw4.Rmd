---
title: "Homework 4 Solutions"
date: "Feb. 15"
output:
  word_document: default
  pdf_document: default
---

# Homework 4

```{r, warning = FALSE, message = FALSE}
library(dplyr)
library(tidyverse)

```

# Setup, load, adjust data

```{r, cache = TRUE}
# https://purl.stanford.edu/hr919hp5420 # code and data location

load(file = read.csv('lydeCopy.csv'))

ls() # List objects in current environment

# Convert failure type to binary
lydeCopy$DV <- as.numeric(!is.na(lydeCopy$X1)) 

# Do not overwrite! Instead create a new variable
lydeCopy$tsi <- as.numeric(lydeCopy$time.since.insp)
# Calculate median tsi for non missing/non-first, INS = inspected facility
mediantsi <- median(lydeCopy$tsi[lydeCopy$cat == "INS" & lydeCopy$tsi != "99999"])
# Map missing/first to median
lydeCopy = lydeCopy %>%
  mutate(tsi = case_when(
    tsi == 99999 ~ mediantsi,
    !is.na(tsi) ~ tsi,
    .default = mediantsi))

# Check whether it worked
mediantsi == median(lydeCopy$tsi)
```
## Exercise 3: Mutating, Plotting
Take fac.final.hist and subset it to inspected facilities (cat=="INS"). Use the quantile function and mutate to add variable whether a row is > the 95th percentile of tsi (e.g. those facilities which have not been inspected in some time), and create a new dataset that only has observations with these faciliites that have not been inspected in a long time.

Next, use the maps package and ggplot to make a map of the US. Plot the violations, and use color, shape, or tranparency to highlight those areas with higher tsi (up to you). Do you notice any spatial clustering of areas that have not been inspected in some time?

```{r}
library(maps)
usa <- map_data("usa")

df3 = subset(lydeCopy, cat == "INS") %>%
  mutate(tsi_95 = ifelse(tsi>quantile(tsi, 0.95), TRUE, FALSE)) %>%
  filter(tsi_95 == TRUE)

ggplot() + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group), fill = "grey") +
  geom_point(data = df3, aes(x = FAC_LONG, y = FAC_LAT, alpha = FAC_DAYS_LAST_INSPECTION), color = 'red') +
  xlim(-130, -60) +
  ylim(25, 50) +
  theme_minimal()

#There is a lot of clustering of facilities that have not been inspected in a long time in a straight line between Texas and Pennsylvania.
```